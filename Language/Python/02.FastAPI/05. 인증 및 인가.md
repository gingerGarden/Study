# 5. ì¸ì¦ ë° ì¸ê°€ (Authentication & Authorization)

* ì¸ì¦(Authentication): ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸
* ì¸ê°€(Authorization): ê·¸ ì‚¬ìš©ìê°€ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸

<br>

| êµ¬ë¶„| ì¸ì¦ (Authentication)| ì¸ê°€ (Authorization)|
| --- | --- | --- |
| **ëª©ì ** | ì‚¬ìš©ìì˜ ì‹ ì› í™•ì¸| ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ê¶Œí•œ í™•ì¸|
| **ê³¼ì •** | ë¡œê·¸ì¸, í† í° ê²€ì¦, API í‚¤ í™•ì¸| ì—­í• (Role), ì ‘ê·¼ ë²”ìœ„ ê²€ì‚¬|
| **ì˜ˆì‹œ** | âœ… ì‚¬ìš©ì ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸<br>âœ… JWT í† í° ìœ íš¨ì„± ê²€ì‚¬<br>âœ… API í‚¤ ê²€ì¦ | âœ… ê´€ë¦¬ìë§Œ ì‚¬ìš©ì ì‚­ì œ í—ˆìš©<br>âœ… íŠ¹ì • ê·¸ë£¹ë§Œ ê²Œì‹œíŒ ì ‘ê·¼ í—ˆìš© |

<br>
<br>

### 1. FastAPIì˜ ë³´ì•ˆ ì ‘ê·¼ ë°©ì‹
* íƒ€ì… íŒíŠ¸ + ì˜ì¡´ì„± ì£¼ì…(Dependency Injection) ìœ¼ë¡œ ë³´ì•ˆ ë¡œì§ì„ ê¹”ë”í•˜ê³  ëª¨ë“ˆí™”
* í‘œì¤€ ì§€ì›: OAuth2, JWT, HTTP Basic/Bearer ë“±
* Swagger UI ìë™ ë¬¸ì„œí™”: Bearer í† í° ì…ë ¥ì°½ë„ ìë™ ì¶”ê°€

```md
 í•µì‹¬: ì¸ì¦/ì¸ê°€ë¥¼ ë³„ë„ì˜ í•¨ìˆ˜(ì˜ì¡´ì„±)ë¡œ ë¶„ë¦¬ â†’ ì¬ì‚¬ìš©ì„± ì¦ê°€ & ì½”ë“œ ê°€ë…ì„± ìƒìŠ¹
```

<br>

* ë°©ì‹ë³„ ìš”ì•½

| ì¸ì¦ ë°©ì‹| ì¥ì | ë‹¨ì | ì‚¬ìš© ì˜ˆ|
| --- | --- | --- | --- |
| **OAuth2 (JWT)**| âœ… í‘œì¤€í™”, âœ… í† í° ê¸°ë°˜, âœ… ìœ ì—°í•œ ê¶Œí•œ ê´€ë¦¬ (`scopes`)  | â— êµ¬í˜„ ë³µì¡ë„ â†‘, â— í† í° ë§Œë£Œ ë° ê°±ì‹  ê´€ë¦¬ í•„ìš”| ì‚¬ìš©ì ë¡œê·¸ì¸, ì™¸ë¶€ ì„œë¹„ìŠ¤ OAuth ì—°ë™|
| **API Key**| âœ… ë§¤ìš° ê°„ë‹¨, âœ… ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì— ì í•©| â— í‰ë¬¸ ë…¸ì¶œ ìœ„í—˜(HTTPS í•„ìˆ˜), â— ì„¸ë¶„í™”ëœ ê¶Œí•œ ê´€ë¦¬ ì–´ë ¤ì›€ | ë‚´ë¶€ ì„œë¹„ìŠ¤ API, ì„œë²„ ê°„ í†µì‹ |
| **HTTP Basic**| âœ… êµ¬í˜„ ë§¤ìš° ê°„ë‹¨, âœ… ë¸Œë¼ìš°ì € ë‚´ì¥ ì§€ì›| â— ë¹„ë°€ë²ˆí˜¸ í‰ë¬¸ ì „ì†¡(HTTPS í•„ìˆ˜), â— ë³´ì•ˆ ì·¨ì•½| PoC, ì„ì‹œ ë³´í˜¸ API|
| **Session Cookie**| âœ… ì‚¬ìš©ì ì¹œí™”ì (ë¸Œë¼ìš°ì € ìë™ ì²˜ë¦¬), âœ… ìƒíƒœ ìœ ì§€ ê°€ëŠ¥| â— CSRF ê³µê²© ì·¨ì•½, â— ì„œë²„ ì„¸ì…˜ ê´€ë¦¬ í•„ìš”| ì „í†µì ì¸ ì›¹ ì•± ë¡œê·¸ì¸ (Flask/Django ìŠ¤íƒ€ì¼) |
| **Mutual TLS (mTLS)** | âœ… ë†’ì€ ë³´ì•ˆì„±(í´ë¼ì´ì–¸íŠ¸/ì„œë²„ ëª¨ë‘ ì¸ì¦), âœ… API Key ë¶ˆí•„ìš” | â— í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ê´€ë¦¬ ë³µì¡ë„ â†‘| ê¸ˆìœµ, IoT, ë‚´ë¶€ ê³ ë³´ì•ˆ API|
| **SAML**| âœ… ì‹±ê¸€ì‚¬ì¸ì˜¨(SSO), âœ… ê¸°ì—… í™˜ê²½ì— ìµœì í™”| â— ë³µì¡í•œ ì„¤ì •, â— ëª¨ë°”ì¼ í™˜ê²½ ì·¨ì•½| ê¸°ì—… ë‚´ë¶€ ì‹œìŠ¤í…œ í†µí•©, SSO|

<br>

| íŠ¹ì§•| OAuth2 | API Key | Basic Auth | Session Cookie | mTLS | SAML |
| --- | --- | --- | --- | --- | --- | --- |
| ğŸ” í† í° ê¸°ë°˜| âœ…| âœ…| âŒ| âŒ| âŒ| âŒ|
| ğŸŒ REST API ì¹œí™”ì | âœ…| âœ…| âœ…| âŒ| âœ…| âŒ|
| ğŸ”„ ìƒíƒœ ìœ ì§€(Sessionless) | âœ…| âœ…| âœ…| âŒ| âœ…| âœ…|
| ğŸ”’ ê³ ë³´ì•ˆ| âœ…| âŒ| âŒ| âŒ| âœ…| âœ…|
| ğŸ¢ ê¸°ì—…/SSO ìµœì í™”| âŒ| âŒ| âŒ| âŒ| âŒ| âœ…|


<br>
<br>
<br>
<br>

## A. OAuth2 (Bearer Token) - ê¶Œì¥ë˜ëŠ” ì¸ì¦ ë°©ì‹

* ê°€ì¥ ì¼ë°˜ì ì´ê³  ê¶Œì¥ë˜ëŠ” ì¸ì¦ ë°©ì‹

* í´ë¼ì´ì–¸íŠ¸ëŠ” ë¡œê·¸ì¸ í›„ ì„œë²„ë¡œë¶€í„° Access Token(JWT) ì„ ë°œê¸‰ë°›ê³  ìš”ì²­ë§ˆë‹¤ ì´ í† í°ì„ ì „ì†¡í•˜ì—¬ ì¸ì¦
* ì„œë²„ëŠ” í† í°ì„ ê²€ì¦í•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³  ìš”ì²­ ì²˜ë¦¬

```text
[1] í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ìš”ì²­
    â†“
[2] ì„œë²„ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    â†“
[3] JWT í† í° ìƒì„± ë° ë°˜í™˜
    â†“
[4] í´ë¼ì´ì–¸íŠ¸ê°€ ì´í›„ ìš”ì²­ ì‹œ Bearer í† í° ì²¨ë¶€
    â†“
[5] ì„œë²„ê°€ í† í° ê²€ì¦ í›„ ìš”ì²­ ì²˜ë¦¬
```

<br>

```md
1ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì¸ ìš”ì²­
* ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸(`/token`)ì— `username/password`ë¥¼ ì „ì†¡

2ï¸âƒ£ ì„œë²„ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
* ì „ì†¡ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ì—¬ DBì— ì €ì¥ëœ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„êµ

3ï¸âƒ£ JWT í† í° ìƒì„±
* ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ë©´ ì‚¬ìš©ì ID, ë§Œë£Œ ì‹œê°„ ë“±ì„ í¬í•¨í•œ JWT Access Token ë°œê¸‰

4ï¸âƒ£ í† í° ë°˜í™˜ ë° ì‚¬ìš©
* ì„œë²„ê°€ JWT í† í°ì„ ë°˜í™˜ â†’ í´ë¼ì´ì–¸íŠ¸ëŠ” ì´í›„ ìš”ì²­ ì‹œ `Authorization: Bearer <token>` í˜•íƒœë¡œ í† í° ì²¨ë¶€

5ï¸âƒ£ ì„œë²„ í† í° ê²€ì¦ í›„ ìš”ì²­ ì²˜ë¦¬
* FastAPI ì—”ë“œí¬ì¸íŠ¸ëŠ” `OAuth2PasswordBearer` ì˜ì¡´ì„±ì„ í†µí•´ í† í°ì„ ì¶”ì¶œ & ê²€ì¦ â†’ ì‚¬ìš©ì ì •ë³´ í™•ì¸ í›„ API ì²˜ë¦¬
```

### A-1. ì½”ë“œ ì˜ˆì‹œ

| ë¼ì´ë¸ŒëŸ¬ë¦¬| ìš©ë„|
| --- | ---- |
| `fastapi.security.OAuth2PasswordBearer`| í† í° ì¶”ì¶œ ë° ìœ íš¨ì„± ê²€ì‚¬|
| `passlib[bcrypt]`| ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë° ê²€ì¦|
| `python-jose[cryptography]`| JWT í† í° ìƒì„± ë° ë””ì½”ë”©|

<br>

```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
from jose import JWTError, jwt
from datetime import datetime, timedelta
from passlib.context import CryptContext
from pydantic import BaseModel

# --- ì„¤ì • --- #
SECRET_KEY = "your-secret-key" # ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ ë“±ìœ¼ë¡œ ê´€ë¦¬
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token") # tokenUrlì€ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸

app = FastAPI()

# --- ëª¨ë¸ --- #
# --- Pydantic ëª¨ë¸ ì •ì˜ --- #
class Token(BaseModel):
    access_token: str         # JWT ì•¡ì„¸ìŠ¤ í† í° ë¬¸ìì—´
    token_type: str           # í† í° íƒ€ì… (ì¼ë°˜ì ìœ¼ë¡œ "bearer")

class TokenData(BaseModel):
    username: str | None = None  # JWT payloadì—ì„œ ì¶”ì¶œí•œ ì‚¬ìš©ì ì´ë¦„

class User(BaseModel):
    username: str             # ì‚¬ìš©ì ID
    email: str | None = None  # ì‚¬ìš©ì ì´ë©”ì¼ (ì˜µì…˜)
    full_name: str | None = None  # ì‚¬ìš©ì ì „ì²´ ì´ë¦„ (ì˜µì…˜)
    disabled: bool | None = None  # ë¹„í™œì„±í™” ì—¬ë¶€ (ì˜µì…˜)

class UserInDB(User):
    hashed_password: str      # DBì— ì €ì¥ëœ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€


# --- ì˜ˆì‹œ ì‚¬ìš©ì ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” DB ì‚¬ìš©) --- #
fake_users_db = {
    "johndoe": {
        "username": "johndoe",
        "email": "john@example.com",
        "full_name": "John Doe",
        "hashed_password": pwd_context.hash("secret"),  # ë¹„ë°€ë²ˆí˜¸ "secret" í•´ì‹œ
    },
    "janedoe": {
        "username": "janedoe",
        "email": "jane@example.com",
        "full_name": "Jane Doe",
        "hashed_password": pwd_context.hash("anothersecret"),  # ë¹„ë°€ë²ˆí˜¸ "anothersecret" í•´ì‹œ
    },
}


# --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ --- #

# í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ì™€ í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¹„êµ
def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

# ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒ (DBì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì²˜ëŸ¼ ë™ì‘)
def get_user(username: str):
    if username in fake_users_db:
        user_dict = fake_users_db[username]
        return UserInDB(**user_dict)  # ë”•ì…”ë„ˆë¦¬ë¥¼ UserInDB ê°ì²´ë¡œ ë³€í™˜

# JWT ì•¡ì„¸ìŠ¤ í† í° ìƒì„±
def create_access_token(data: dict, expires_delta: timedelta | None = None):
    to_encode = data.copy()  # ì‚¬ìš©ì ë°ì´í„° ë³µì‚¬
    # í† í° ë§Œë£Œ ì‹œê°„ ì„¤ì •
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})  # ë§Œë£Œ ì •ë³´ ì¶”ê°€
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt


# í˜„ì¬ ìš”ì²­ì˜ Bearer í† í°ì„ ê²€ì¦í•˜ê³  ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
async def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",  # ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        # JWT í† í° ë””ì½”ë”©
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")  # payloadì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ
        if username is None:
            raise credentials_exception
        token_data = TokenData(username=username)
    except JWTError:
        raise credentials_exception
    user = get_user(token_data.username)  # ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    if user is None:
        raise credentials_exception
    return user

# ë¹„í™œì„±í™”ëœ ì‚¬ìš©ì ì°¨ë‹¨
async def get_current_active_user(current_user: User = Depends(get_current_user)):
    if current_user.disabled:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Inactive user"  # ë¹„í™œì„± ì‚¬ìš©ì ì ‘ê·¼ ì°¨ë‹¨
        )
    return current_user


# --- ì—”ë“œí¬ì¸íŠ¸ ì •ì˜ --- #

# ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸: username/passwordë¡œ ë¡œê·¸ì¸ â†’ JWT í† í° ë°˜í™˜
@app.post("/token", response_model=Token)
async def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):
    user = get_user(form_data.username)  # ì‚¬ìš©ì ì¡°íšŒ
    # ì‚¬ìš©ì ì—†ìŒ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ ì‹œ ì—ëŸ¬ ë°˜í™˜
    if not user or not verify_password(form_data.password, user.hashed_password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Incorrect username or password",
            headers={"WWW-Authenticate": "Bearer"},
        )
    # JWT í† í° ìƒì„± ë° ë°˜í™˜
    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    access_token = create_access_token(
        data={"sub": user.username}, expires_delta=access_token_expires
    )
    return {"access_token": access_token, "token_type": "bearer"}

# ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ë°˜í™˜ ì—”ë“œí¬ì¸íŠ¸
@app.get("/users/me/", response_model=User)
async def read_users_me(current_user: User = Depends(get_current_active_user)):
    return current_user

# ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì†Œìœ  ì•„ì´í…œ ë°˜í™˜ ì—”ë“œí¬ì¸íŠ¸
@app.get("/users/me/items/")
async def read_own_items(current_user: User = Depends(get_current_active_user)):
    return [{"item_id": "Foo", "owner": current_user.username}]
```

<br>
<br>
<br>
<br>

## B. API Key ì¸ì¦

* í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ ì‹œ ê³ ìœ í•œ API í‚¤ë¥¼ í—¤ë”(Header), ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°(Query), ë˜ëŠ” **ì¿ í‚¤(Cookie)**ì— í¬í•¨
> * ì„œë²„ê°€ ì´ë¥¼ ê²€ì¦í•´ ìš”ì²­ í—ˆìš© ì—¬ë¶€ ê²°ì •
* ì£¼ë¡œ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì´ë‚˜ ê°„ë‹¨í•œ ì¸ì¦ì— ì‚¬ìš©
* ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•´ HTTPS ì‚¬ìš© í•„ìˆ˜ (í‚¤ê°€ í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œë¨)

<br>
<br>

### B-1. ì£¼ìš” ë©”ì„œë“œ ì„¤ëª…
* `fastapi.security` ë‚´ë¶€ ë©”ì„œë“œ ì‚¬ìš©

| êµ¬ì„±ìš”ì†Œ| ì„¤ëª…| OpenAPI ë¬¸ì„œ ë…¸ì¶œ|
| --- | --- | --- |
| `APIKeyHeader`| HTTP í—¤ë”ì—ì„œ API í‚¤ ì¶”ì¶œ| âŒ Depends ì‚¬ìš© ì‹œ |
| `APIKeyQuery`| URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ API í‚¤ ì¶”ì¶œ | âŒ Depends ì‚¬ìš© ì‹œ |
| `APIKeyCookie`| ì¿ í‚¤ì—ì„œ API í‚¤ ì¶”ì¶œ| âŒ Depends ì‚¬ìš© ì‹œ |
| `Security()`| ë³´ì•ˆ ì˜ì¡´ì„±ìœ¼ë¡œ OpenAPI í‘œì‹œ| âœ… ë¬¸ì„œì— ë…¸ì¶œë¨|

* Securityë¡œ ê°ì‹¸ë©´ Swaggerì— "Authorize ë²„íŠ¼"ì´ ìë™ í‘œì‹œë¨

<br>
<br>

### B-2. ì½”ë“œ ì˜ˆì‹œ

```python
from fastapi import FastAPI, Depends, HTTPException, status, Security
from fastapi.security import APIKeyHeader

app = FastAPI()

# --- ğŸ”‘ ì„¤ì •: API í‚¤ ê°’ ë° í—¤ë” ì´ë¦„ ì •ì˜ --- #
API_KEY = "your-super-secret-api-key"  # âœ… ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  í™˜ê²½ ë³€ìˆ˜(.env) ì‚¬ìš© ê¶Œì¥
API_KEY_NAME = "X-API-Key"             # âœ… í´ë¼ì´ì–¸íŠ¸ê°€ API í‚¤ë¥¼ ë‹´ì•„ì•¼ í•  í—¤ë” ì´ë¦„

# APIKeyHeader:
# í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì—ì„œ ì§€ì •í•œ í—¤ë”(X-API-Key)ë¥¼ ì½ì–´ì˜´
# auto_error=True â†’ í—¤ë”ê°€ ì—†ê±°ë‚˜ ì˜ëª»ëœ ê²½ìš° 403 ì—ëŸ¬ ìë™ ë°˜í™˜
api_key_header = APIKeyHeader(name=API_KEY_NAME, auto_error=True)


# --- ğŸ›¡ï¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: API í‚¤ ê²€ì¦ ë¡œì§ --- #
async def get_api_key(api_key: str = Security(api_key_header)):
    """
    âœ… ìš”ì²­ì—ì„œ ì¶”ì¶œí•œ API í‚¤ê°€ ì„œë²„ì˜ API_KEYì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦
    """
    if api_key == API_KEY:
        return api_key  # ê²€ì¦ ì„±ê³µ â†’ API í‚¤ ë°˜í™˜
    else:
        # ê²€ì¦ ì‹¤íŒ¨ â†’ 403 Forbidden ì—ëŸ¬ ë°˜í™˜
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Could not validate API Key"  # ì˜¤ë¥˜ ë©”ì‹œì§€
        )


# --- ğŸ“¦ ì—”ë“œí¬ì¸íŠ¸: API í‚¤ ì¸ì¦ ì ìš© --- #

@app.get("/items/")
async def read_items(api_key: str = Depends(get_api_key)):
    """
    âœ… API í‚¤ê°€ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ í˜¸ì¶œ ê°€ëŠ¥
    - í´ë¼ì´ì–¸íŠ¸ëŠ” ìš”ì²­ í—¤ë”ì— X-API-Keyë¥¼ í¬í•¨í•´ì•¼ í•¨
    - ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ 403 Forbidden ë°˜í™˜
    """
    return [{"item_id": "Foo", "api_key": api_key}]


@app.get("/admin/")
async def read_admin_data(api_key: str = Security(get_api_key)):
    """
    âœ… ê´€ë¦¬ì ì „ìš© ì—”ë“œí¬ì¸íŠ¸
    - get_api_key í•¨ìˆ˜ë¥¼ Security()ë¡œ ì˜ì¡´ì„± ì£¼ì…
    - OpenAPI ë¬¸ì„œì— ì¸ì¦ í•„ìš” í‘œì‹œë¨
    """
    return {"message": "Welcome, admin!"}
```

<br>
<br>

### B-3. ì‹¤ì „ íŒ
* API_KEYëŠ” ë°˜ë“œì‹œ `.env` íŒŒì¼ì— ì €ì¥í•˜ê³  `os.getenv()`ë¡œ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.

* ë°˜ë“œì‹œ HTTPSë¡œ í†µì‹ í•˜ì„¸ìš” (API í‚¤ê°€ í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œë  ìˆ˜ ìˆìŒ).
* `Security()`ë¥¼ ì“°ë©´ Swagger UIì— ì¸ì¦ ìŠ¤í‚¤ë§ˆ ìë™ í‘œì‹œ â†’ íŒ€ í˜‘ì—… ì‹œ ë§¤ìš° ìœ ìš©.

<br>
<br>
<br>
<br>

## C. HTTP Basic ì¸ì¦

* ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ `Authorization` í—¤ë”ì— Base64 ì¸ì½”ë”©ëœ ë¬¸ìì—´ë¡œ ì „ì†¡

* ë³´ì•ˆìƒ ì·¨ì•½í•˜ë¯€ë¡œ HTTPSì™€ í•¨ê»˜ ì‚¬ìš© í•„ìˆ˜

* ì£¼ë¡œ ë‚´ë¶€ API, í…ŒìŠ¤íŠ¸ìš©, ë‹¨ìˆœ ë³´í˜¸ìš©ì— ì í•© (ëŒ€ì‹  OAuth2 ê¶Œì¥)

<br>
<br>

### C-1. í•µì‹¬ êµ¬ì„± ìš”ì†Œ

* `fastapi.security` ë‚´ë¶€ ë©”ì„œë“œ ì‚¬ìš©

| êµ¬ì„±ìš”ì†Œ| ì„¤ëª…|
| --- | --- |
| `HTTPBasic`| í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì—ì„œ Basic ì¸ì¦ í—¤ë” íŒŒì‹±|
| `HTTPBasicCredentials`| username, password í•„ë“œë¥¼ ë‹´ëŠ” ëª¨ë¸ |
| `passlib[bcrypt]`| ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ë° ê²€ì¦|

<br>
<br>

### C-2. ì½”ë“œ ì˜ˆì‹œ

```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.security import HTTPBasic, HTTPBasicCredentials
from passlib.context import CryptContext

app = FastAPI()

# --- ğŸ” HTTP Basic ì„¤ì • --- #
# í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì˜ Authorization í—¤ë”(Base64 ì¸ì½”ë”©)ë¥¼ íŒŒì‹±
security = HTTPBasic()

# bcrypt ë¹„ë°€ë²ˆí˜¸ í•´ì‹± ì„¤ì •
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# --- ğŸ—‚ï¸ ì‚¬ìš©ì ë°ì´í„°ë² ì´ìŠ¤ (ì˜ˆì‹œ) --- #
# ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” DB ë˜ëŠ” ì™¸ë¶€ ì¸ì¦ ì„œë²„ ì‚¬ìš©
users_db = {
    "testuser": pwd_context.hash("testpassword"),
    "admin": pwd_context.hash("adminpassword"),
}


# --- ğŸ›¡ï¸ ì¸ì¦ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ --- #
def verify_basic_credentials(credentials: HTTPBasicCredentials) -> bool:
    """
    âœ… í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°›ì€ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê²€ì¦
    - ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    - ë¹„ë°€ë²ˆí˜¸ëŠ” bcrypt í•´ì‹œì™€ ë¹„êµ
    """
    username = credentials.username
    password = credentials.password

    # ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
    if username not in users_db:
        return False

    # ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    if not pwd_context.verify(password, users_db[username]):
        return False

    return True


# --- ğŸšª ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸ --- #
@app.get("/basic-protected")
async def basic_protected_route(credentials: HTTPBasicCredentials = Depends(security)):
    """
    âœ… HTTP Basic ì¸ì¦ì´ ì ìš©ëœ ì—”ë“œí¬ì¸íŠ¸
    - í´ë¼ì´ì–¸íŠ¸ëŠ” Authorization í—¤ë”ì—
      'Basic base64(username:password)' í˜•íƒœë¡œ ì „ì†¡í•´ì•¼ í•¨
    - ì¸ì¦ ì‹¤íŒ¨ ì‹œ 401 Unauthorized ë°˜í™˜ + WWW-Authenticate í—¤ë” í¬í•¨
    """
    if not verify_basic_credentials(credentials):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Incorrect username or password",
            headers={"WWW-Authenticate": "Basic"},  # ë¸Œë¼ìš°ì €ì— ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        )

    return {
        "message": f"Hello, {credentials.username}! "
                   "You are authenticated with Basic Auth."
    }
```

<br>
<br>
<br>
<br>

## D. ì¸ê°€ (Authorization) - ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)

* ì¸ì¦ëœ ì‚¬ìš©ìì—ê²Œ ì—­í• (`admin`, `user`, `guest` ë“±)ì„ ë¶€ì—¬í•˜ê³ , ì—­í• ì— ë”°ë¼ API ì ‘ê·¼ ê¶Œí•œì„ ë‹¤ë¥´ê²Œ ì„¤ì •

* ì£¼ë¡œ ê´€ë¦¬ì ì „ìš© API ë˜ëŠ” íŠ¹ì • ê·¸ë£¹ ê¸°ëŠ¥ ì œí•œì— ì‚¬ìš©

<br>
<br>

### D-1. í•µì‹¬ ê°œë…

* ì¸ì¦ ê³¼ì •ì—ì„œ ì–»ì€ ì‚¬ìš©ì ì •ë³´(ì˜ˆ: JWT í† í°ì— í¬í•¨ëœ ì—­í• )ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤.
* ë³„ë„ì˜ ì˜ì¡´ì„± í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ íŠ¹ì • ì—­í• ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì œí•œí•©ë‹ˆë‹¤.

| ê°œë…| ì„¤ëª…|
| --- | --- |
| **ì—­í• (Role)** | ì‚¬ìš©ì ê·¸ë£¹ ë¶„ë¥˜ (`admin`, `editor`, `viewer` ë“±) |
| **RBAC**| Roleì— ë”°ë¼ API ì ‘ê·¼ í—ˆìš© ì—¬ë¶€ ê²°ì •|
| **ì˜ì¡´ì„± ì£¼ì…**| ì—­í•  ì²´í¬ ë¡œì§ì„ ì˜ì¡´ì„± í•¨ìˆ˜ë¡œ ë¶„ë¦¬ â†’ ì½”ë“œ ì¤‘ë³µ ì œê±°|


<br>
<br>

### D-2. ì½”ë“œ ì˜ˆì‹œ

```python
from fastapi import FastAPI, Depends, HTTPException, status
from pydantic import BaseModel

app = FastAPI()

# --- ğŸ§‘â€ğŸ’» ì‚¬ìš©ì ëª¨ë¸ (ì˜ˆì‹œ) --- #
class User(BaseModel):
    username: str
    role: str  # ex) "admin", "user", "guest"


# --- ğŸ›¡ï¸ í˜„ì¬ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸° (ê°€ì •) --- #
async def get_current_user_with_role() -> User:
    """
    âœ… ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” JWT í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    ì—¬ê¸°ì„  ì˜ˆì‹œë¡œ í•˜ë“œì½”ë”©ëœ admin_user ë°˜í™˜
    """
    return User(username="admin_user", role="admin")
    # return User(username="normal_user", role="user")  # ì¼ë°˜ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ìš©


# --- ğŸ”‘ ì—­í•  ê²€ì‚¬ ì˜ì¡´ì„± í•¨ìˆ˜ --- #
def role_required(required_role: str):
    """
    âœ… ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ì‹œ ì§€ì •ëœ ì—­í• (required_role)ì„ ê°€ì§„ ì‚¬ìš©ìë§Œ í—ˆìš©
    """
    async def role_checker(current_user: User = Depends(get_current_user_with_role)):
        if current_user.role != required_role:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Role '{required_role}' required to access this resource"
            )
        return current_user  # ê¶Œí•œì´ ë§ìœ¼ë©´ ì‚¬ìš©ì ê°ì²´ ë°˜í™˜
    return role_checker


# --- ğŸšª ì—”ë“œí¬ì¸íŠ¸ ì •ì˜ --- #
@app.get("/admin-only")
async def admin_only_route(
    current_user: User = Depends(role_required("admin"))
):
    """
    âœ… ê´€ë¦¬ì ì „ìš© API
    - role_required("admin")ìœ¼ë¡œ ê´€ë¦¬ì ê¶Œí•œë§Œ í—ˆìš©
    """
    return {"message": f"Welcome, {current_user.username}! You are an admin."}


@app.get("/user-and-admin")
async def user_and_admin_route(
    current_user: User = Depends(get_current_user_with_role)
):
    """
    âœ… ëª¨ë“  ì¸ì¦ ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥ (ì—­í•  ì œí•œ ì—†ìŒ)
    """
    return {
        "message": f"Hello, {current_user.username}! "
                   f"You are a {current_user.role}."
    }


# --- ğŸ“ í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  JWT ë°œê¸‰) --- #
@app.get("/login-as-admin")
async def login_as_admin():
    """
    âœ… í…ŒìŠ¤íŠ¸ìš©: ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
    """
    return await get_current_user_with_role()

@app.get("/login-as-user")
async def login_as_user():
    """
    âœ… í…ŒìŠ¤íŠ¸ìš©: ì¼ë°˜ ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
    """
    return User(username="normal_user", role="user")

```

<br>
<br>
<br>
<br>

## E. ë³´ì•ˆ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° ë° ì‹¤ì „ íŒ

### E-1. `Security` ë°ì½”ë ˆì´í„°
* `Depends`ì™€ ìœ ì‚¬í•˜ì§€ë§Œ ë³´ì•ˆ ì˜ì¡´ì„±ì„ì„ ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œ
* Swagger UIì—ì„œ ì¸ì¦ ë²„íŠ¼(`Authorize`) ìë™ í‘œì‹œ
* `Security`ë¥¼ ì‚¬ìš©í•˜ë©´ OpenAPI ë¬¸ì„œì— ì¸ì¦ ìŠ¤í‚¤ë§ˆê°€ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.

```python
from fastapi import Security
from fastapi.security import APIKeyHeader

api_key_header = APIKeyHeader(name="X-API-Key")

@app.get("/secure-data/")
async def get_secure_data(api_key: str = Security(api_key_header)):
    return {"data": "This is protected"}
```

<br>
<br>

### E-2. HTTPException
* ì¸ì¦/ì¸ê°€ ì‹¤íŒ¨ ì‹œ ì ì ˆí•œ HTTP ìƒíƒœ ì½”ë“œì™€ ë©”ì‹œì§€ ë°˜í™˜
* `WWW-Authenticate` í—¤ë” ì¶”ê°€ ì‹œ í´ë¼ì´ì–¸íŠ¸ê°€ ì¸ì¦ ë°©ì‹ ì¸ì§€ ê°€ëŠ¥

```python
from fastapi import HTTPException, status

raise HTTPException(
    status_code=status.HTTP_401_UNAUTHORIZED,
    detail="Invalid credentials",
    headers={"WWW-Authenticate": "Bearer"},
)
```
| ì½”ë“œ  | ìƒí™©|
| --- | --- |
| 401 | ì¸ì¦ ì‹¤íŒ¨ (Unauthorized)|
| 403 | ê¶Œí•œ ì—†ìŒ (Forbidden)|
| 419 | ì„¸ì…˜ ë§Œë£Œ (Token Expired, ì„ íƒì ) |

<br>
<br>

### E-3. í† í° ë§Œë£Œ ë° ê°±ì‹  ì „ëµ
* ì§§ì€-lived Access Token + ê¸´-lived Refresh Token ì¡°í•© ê¶Œì¥

* ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ ì‹œ, ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì¬ë°œê¸‰ API í˜¸ì¶œ

```text
Client ----[Access Token]----> API (30ë¶„ ìœ íš¨)
       ----[Refresh Token]---> Token Refresh API (7ì¼ ìœ íš¨)
```

<br>
<br>

### E-4. í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
* ë¯¼ê° ì •ë³´ëŠ” ì½”ë“œì— í•˜ë“œì½”ë”© âŒ
* `.env` íŒŒì¼ ë˜ëŠ” ë¹„ë°€ ê´€ë¦¬ ì„œë¹„ìŠ¤ë¡œ ë¶„ë¦¬

* `.env` ì˜ˆì œ
```ini
SECRET_KEY=super-secret-key
DATABASE_URL=postgresql://user:pass@localhost/db
```

* Pydantic Settings ì‚¬ìš©

```python
from pydantic import BaseSettings

class Settings(BaseSettings):
    SECRET_KEY: str
    DATABASE_URL: str

    class Config:
        env_file = ".env"

settings = Settings()
print(settings.SECRET_KEY)
```

<br>
<br>

### E-5. CORS ì„¤ì •
* í¬ë¡œìŠ¤ ë„ë©”ì¸ ìš”ì²­ì„ ì œì–´í•˜ì—¬ CSRF ê³µê²© ì˜ˆë°©

* `CORSMiddleware` ì‚¬ìš©
* `allow_origins=["*"]`ëŠ” ê°œë°œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê³ , í”„ë¡œë•ì…˜ì—ì„œëŠ” ë„ë©”ì¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì§€ì •

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://frontend.example.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

<br>
<br>

* ì‹¤ì „ ì¶”ê°€ íŒ

| í•­ëª©| ì„¤ëª…|
| --- | ---- |
| ğŸ”’ **HTTPS ê°•ì œ**| ëª¨ë“  ìš”ì²­ì€ TLSë¡œ ì•”í˜¸í™” (Let's Encrypt ì¶”ì²œ)|
| ğŸ•µï¸â€â™‚ï¸ **Rate Limiting** | ê³¼ë„í•œ ìš”ì²­ ë°©ì§€ (FastAPI + Redisë¡œ êµ¬í˜„ ê°€ëŠ¥)|
| ğŸ” **OAuth2 + Scopes**   | APIë³„ ì„¸ë¶€ ê¶Œí•œ ê´€ë¦¬ (ì˜ˆ: `read:users`, `edit:items`) |
| ğŸ›¡ï¸ **MFA (2FA) ì§€ì› ê³ ë ¤**| ê´€ë¦¬ì ë° ë¯¼ê° APIì—ëŠ” ë‹¤ì¤‘ ì¸ì¦ ë‹¨ê³„ ì¶”ê°€|
| ğŸ“¦ **API Gateway ì‚¬ìš©**| JWT ê²€ì¦, Rate Limiting, CORSë¥¼ Gatewayì—ì„œ ì²˜ë¦¬|

<br>

* ì´ì •ë¦¬: ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ ë³´ì•ˆ ì „ëµ

| ë ˆë²¨| ì „ëµ|
| --- | --- |
| ğŸ” API ì¸ì¦ | OAuth2 + JWT / API Key|
| ğŸ”„ ì„¸ì…˜ ê´€ë¦¬  | Refresh Token, Redis ì„¸ì…˜ ì €ì¥|
| ğŸŒ ë„¤íŠ¸ì›Œí¬   | HTTPS, CORS, CSRF ë³´í˜¸|
| ğŸ›¡ï¸ ì¸í”„ë¼   | WAF(Web Application Firewall), API Gateway |
| ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬ | RBAC(Role-Based Access Control)|

